var bus = require('../systemBus');
var board = require('board');
var observer = require('observer');
var pieceClass = require('pieces');

function translate(cellString) {
    var map = {
        'A': '1',
        'B': '2',
        'C': '3',
        'D': '4',
        'E': '5',
        'F': '6',
        'G': '7',
        'H': '8'
    };

    cellString = cellString.replace(/^[A-H]/, function(char) { return map[char] });
    return cellString;
}

function gameEngine() {
    var that = this;
    var pieces = new pieceClass();
    this.board = new board(pieces);
    this.observer = new observer(this.board, pieces);

    bus.on('move', function(data) {
        var square =
	        that.board.getGridSquare(translate(data[0])[0], data[0][1]);

        var validMove = that.observer.move(square,
                                           translate(data[1])[0],
                                           data[1][1]);

        if (validMove)
            bus.emit('moved', data);

        console.log('Not a valid move');
        return;
    });
    bus.on('clear', function() {
        // Destroy the game
    });

    return this.board.getPiecemap();
}

module.exports = gameEngine;