var bus = require('../systemBus');
var board = require('board');
var observer = require('observer');
var pieceClass = require('pieces');

function translate(cellString) {
    var map = {
        'A': '1',
        'B': '2',
        'C': '3',
        'D': '4',
        'E': '5',
        'F': '6',
        'G': '7',
        'H': '8'
    };

    cellString = cellString.replace(/^[A-H]/, function(char) { return map[char] });
    return cellString;
}

function gameEngine(bus) {
    var that = this;
    var pieces = new pieceClass();
    this.board = new board(pieces);
    this.bus = bus;
    this.observer = new observer(this.board, pieces, this.bus);

    this.bus.on('move', function(data) {
        var square =
	        that.board.getGridSquare(translate(data[0])[0], data[0][1]);

        console.log(square);
        console.log(data[2]);
        console.log(translate(data[1])[0]);
        console.log(data[1][1]);

        var validMove = that.observer.move(square,
                                           data[2],
                                           translate(data[1])[0],
                                           data[1][1]);
        console.log(validMove);

        if (validMove === 'CheckMate')
            that.bus.emit('moved', 'checkmate');
        if (validMove)
            that.bus.emit('moved', data);
        else
            that.bus.emit('moved', 'invalid');
        return;
    });
    this.bus.on('clear', function() {
        // Destroy the game
    });
}

module.exports = gameEngine;